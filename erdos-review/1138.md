# Review: Erdos Problem 1138

**Problem:** Asymptotic formula for primes in intervals near maximum gaps
**Source:** [erdosproblems.com/1138](https://www.erdosproblems.com/1138)
**Status:** OPEN

## Source Problem

Let x/2 < y < x and C > 1. If d = max_{p_n < x} (p_{n+1} - p_n) denotes the maximum prime gap below x, is it true that:

  pi(y + Cd) - pi(y) ~ Cd / log y

as x -> infinity?

## Current Formalization

```lean
/-- Maximum prime gap below x -/
noncomputable def d (x : ‚Ñù) : ‚Ñù :=
  sSup {g : ‚Ñù | ‚àÉ (p p' : ‚Ñï), p.Prime ‚àß p'.Prime ‚àß p < p' ‚àß
    (‚àÄ q : ‚Ñï, p < q ‚Üí q < p' ‚Üí ¬¨ q.Prime) ‚àß (p : ‚Ñù) < x ‚àß g = (p' - p : ‚Ñù)}

@[category research open, AMS 11]
theorem primes_near_max_gaps (C : ‚Ñù) (hC : 1 < C) :
    answer(sorry) ‚Üî
      ‚àÄ (y : ‚Ñù ‚Üí ‚Ñù), (‚àÄ·∂† x in atTop, x / 2 < y x ‚àß y x < x) ‚Üí
        Tendsto (fun x : ‚Ñù =>
          ((Nat.primeCounting ‚åäy x + C * d x‚åã‚Çä : ‚Ñù) -
           (Nat.primeCounting ‚åäy x‚åã‚Çä : ‚Ñù)) /
          (C * d x / Real.log (y x))) atTop (ùìù 1) := by
  sorry
```

## Critical Analysis

### 1. Asymptotic structure is correctly captured (POSITIVE)

The previous formalization had x and y as fixed parameters, making the Tendsto statement trivially about a constant. The rewrite correctly makes x the variable tending to infinity and y a function of x, with the asymptotic ratio tending to 1. This is a fundamental improvement.

### 2. answer(sorry) correctly used (POSITIVE)

The source asks "is it true that...?", making this a yes/no question. Using `answer(sorry)` is appropriate for an open problem where the answer is unknown.

### 3. Definition of d(x) is correct (POSITIVE)

The definition `d(x) = sSup {g | exists p p' primes with p < p', consecutive, p < x, and g = p' - p}` correctly computes the maximum gap between consecutive primes below x. The consecutiveness condition `‚àÄ q, p < q ‚Üí q < p' ‚Üí ¬¨ q.Prime` ensures p and p' are adjacent primes. The condition `(p : ‚Ñù) < x` ensures we only look at primes below x. The value `g = (p' - p : ‚Ñù)` captures the gap size.

One subtlety: the condition `(p : ‚Ñù) < x` means p < x, but p' could be >= x. The source says d = max_{p_n < x} (p_{n+1} - p_n), which means the prime p_n is below x but p_{n+1} could be above x. The formalization matches this interpretation correctly.

### 4. Quantification over y is well-handled (POSITIVE)

The source says "let x/2 < y < x". In the asymptotic context, y can depend on x. The formalization correctly uses `‚àÄ (y : ‚Ñù ‚Üí ‚Ñù)` to universally quantify over all functions y of x, with the constraint `‚àÄ·∂† x in atTop, x / 2 < y x ‚àß y x < x` ensuring that eventually y(x) lies in (x/2, x). This captures the intent that the asymptotic formula should hold for any choice of y in the allowed range.

### 5. Use of Nat.primeCounting with floor (POSITIVE)

Since `Nat.primeCounting` takes a natural number argument, the formalization uses `‚åäy x + C * d x‚åã‚Çä` (natural number floor) to convert the real argument. This is the standard way to interface between real-valued bounds and the discrete prime counting function.

### 6. The asymptotic ratio (POSITIVE)

The ratio `(pi(‚åäy(x) + C*d(x)‚åã) - pi(‚åäy(x)‚åã)) / (C*d(x) / log(y(x)))` correctly captures the asymptotic relation pi(y + Cd) - pi(y) ~ Cd/log(y). The relation f ~ g means f/g -> 1, which is exactly what `Tendsto ... atTop (nhds 1)` asserts.

### 7. Tendsto on ‚Ñù atTop (MODERATE concern)

The Tendsto is over `atTop` for `‚Ñù`, meaning x -> +infinity over real numbers. The source problem naturally considers x tending to infinity, so this is correct. However, one could argue that since prime gaps are defined for natural-number primes, one might want x to range over naturals. But since d(x) is defined for real x (taking the sup over natural primes below x), and y(x) is real-valued, using real-valued x is a reasonable and correct choice.

### 8. sSup well-definedness (MINOR concern)

The set `{g : ‚Ñù | ...}` in the definition of `d(x)` needs to be nonempty and bounded above for `sSup` to behave correctly. For x > 3, there exist at least two primes below x (namely 2 and 3), so the set is nonempty. The set is bounded above by x (since p' - p < x for primes p < x). For x <= 3, the set might be empty, but since we only care about the eventual behavior (x -> infinity), this is not an issue for the theorem statement. However, formally, `sSup ‚àÖ = 0` in Lean's ConditionallyCompleteLattice for ‚Ñù, which is a reasonable default.

### 9. Natural number subtraction in gap definition (MINOR)

The definition uses `(p' - p : ‚Ñù)` where p, p' are natural numbers. In Lean 4, `p' - p` for natural numbers is truncated subtraction (returns 0 if p' < p). However, since the definition includes `p < p'`, we have p' >= p + 1, so `p' - p >= 1` and the subtraction is correct. The cast to ‚Ñù then gives the correct real-valued gap.

### 10. Use of ‚åä¬∑‚åã‚Çä (natural number floor) (MINOR)

The formalization uses `‚åäy x + C * d x‚åã‚Çä` and `‚åäy x‚åã‚Çä` where `‚åä¬∑‚åã‚Çä` is the natural number floor (which maps negative reals to 0). Since y(x) > x/2 > 0 for large x, and d(x) >= 0 and C > 1, both arguments are positive for large x, so `‚åä¬∑‚åã‚Çä` gives the correct floor value. This is appropriate.

## What a proper formalization would look like

The current formalization is already a faithful and essentially complete capture of the source problem. No structural changes are needed.

```lean
-- The current formalization is already correct. Reproduced for completeness:
noncomputable def d (x : ‚Ñù) : ‚Ñù :=
  sSup {g : ‚Ñù | ‚àÉ (p p' : ‚Ñï), p.Prime ‚àß p'.Prime ‚àß p < p' ‚àß
    (‚àÄ q : ‚Ñï, p < q ‚Üí q < p' ‚Üí ¬¨ q.Prime) ‚àß (p : ‚Ñù) < x ‚àß g = (p' - p : ‚Ñù)}

@[category research open, AMS 11]
theorem primes_near_max_gaps (C : ‚Ñù) (hC : 1 < C) :
    answer(sorry) ‚Üî
      ‚àÄ (y : ‚Ñù ‚Üí ‚Ñù), (‚àÄ·∂† x in atTop, x / 2 < y x ‚àß y x < x) ‚Üí
        Tendsto (fun x : ‚Ñù =>
          ((Nat.primeCounting ‚åäy x + C * d x‚åã‚Çä : ‚Ñù) -
           (Nat.primeCounting ‚åäy x‚åã‚Çä : ‚Ñù)) /
          (C * d x / Real.log (y x))) atTop (ùìù 1) := by
  sorry
```

## Confidence: **85%**

The formalization is a faithful capture of the source problem. The asymptotic structure (x -> infinity with y(x) in (x/2, x)), the definition of maximum prime gap d(x), the prime counting function, and the asymptotic ratio are all correctly formalized. The main sources of residual uncertainty are: (1) whether `sSup` behaves correctly for the gap set in edge cases (minor, since we care about eventual behavior), (2) whether the universally quantified y adequately captures the source's "let x/2 < y < x" (it does -- universally quantifying over all such y functions is the correct formalization of an asymptotic that should hold uniformly for all y in the range), and (3) minor details around natural number floor vs real floor (correctly handled with `‚åä¬∑‚åã‚Çä`).
